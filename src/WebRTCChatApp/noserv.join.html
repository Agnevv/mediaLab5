<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title> JOIN WebRTC channel </title>
    <link href="noserv.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  </head>
  <body>
    <h2>  JOIN WebRTC channel  <span id="status"> init </span> </h2>
    <h3> 2.GET Offer's SDP</h3>
    <textarea id="creater-sdp" placeholder="HERE COPY & PASTE [1.CREATE Offer's SDP]"></textarea>
    <h3> 3.CREATE Participant'S SDP <button id="create">CREATE</button> </h3>
    <textarea id="joiner-sdp"></textarea>
    <h3> CHAT </h3>
    <div id="chat">
      <div id="chat-screen-wp">
        <div id="chat-screen"></div>
      </div>
      <div id="ct"><input id="msg" disabled><button id="send" disabled>send</button></div>
    </div>

    <h3> Capture a picture </h3>
    <div>
      <video id="localVideo" autoplay muted style="width:100%; height:auto; border:1px solid #ccc;"></video> <br>
      <button id="startCamera">Start</button>
      <button id="stopCamera" disabled>Stop</button>
      <button id="captureImage" disabled>Capture & Send Image</button>
    </div>

    <script>
      //var server       = { urls: "stun:stun.l.google.com:19302" };
      var sdpConstraints = { optional: [{RtpDataChannels: true}]  };
      var pc = new RTCPeerConnection(null);
      var dc;
      var localStream = null;
      
      pc.ondatachannel  = function(e) {dc = e.channel; dcInit(dc)};
      pc.onicecandidate = function(e) {
        if (e.candidate) return;
        $("#joiner-sdp").val(JSON.stringify(pc.localDescription));
      };
      pc.oniceconnectionstatechange = function(e) {
        var state = pc.iceConnectionState
        $('#status').html(state);
        if (state == "connected") $("#msg, #send").attr("disabled", false);
      };

      // Start camera
      $("#startCamera").click(function() {
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
          .then(function(stream) {
            localStream = stream;
            $("#localVideo")[0].srcObject = stream;
            $("#captureImage").attr("disabled", false);
            $("#stopCamera").attr("disabled", false);
            $("#startCamera").attr("disabled", true);
          })
          .catch(function(err) {
            addMSG("Camera error: " + err.message, "info");
          });
      });

      // Stop camera
      $("#stopCamera").click(function() {
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          $("#localVideo")[0].srcObject = null;
          localStream = null;
          $("#captureImage").attr("disabled", true);
          $("#stopCamera").attr("disabled", true);
          $("#startCamera").attr("disabled", false);
        }
      });

      // Capture and send image
      $("#captureImage").click(function() {
        if (!localStream || !dc || dc.readyState !== "open") {
          addMSG("Not connected or no camera!", "info");
          return;
        }

        var video = $("#localVideo")[0];
        var canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        var base64Image = canvas.toDataURL('image/jpeg', 0.7);
        dc.send(JSON.stringify({ type: 'image', data: base64Image }));

        // Display sent image in chat
        var wrap = $("<div>").addClass("wrap").appendTo($("#chat-screen"));
        var div = $("<div>").addClass("me").appendTo(wrap);
        $("<span>").html("me").addClass("who").appendTo(div);
        var img = $("<img>").attr("src", base64Image).css({maxWidth: "200px", display: "block", marginTop: "5px"});
        img.appendTo(div);
        $("#chat-screen-wp").scrollTop($("#chat-screen").height());
      });

      function dcInit(dc) {
        dc.onopen = function() {
          $("textarea").attr("disabled",true);
          addMSG("CONNECTED!", "info");
        };
        dc.onmessage = function(e) {
          if (e.data) {
            try {
              var msg = JSON.parse(e.data);
              if (msg.type === 'image') {
                // Display received image
                var wrap = $("<div>").addClass("wrap").appendTo($("#chat-screen"));
                var div = $("<div>").addClass("other").appendTo(wrap);
                $("<span>").html("other").addClass("who").appendTo(div);
                var img = $("<img>").attr("src", msg.data).css({maxWidth: "200px", display: "block", marginTop: "5px"});
                img.appendTo(div);
                $("#chat-screen-wp").scrollTop($("#chat-screen").height());
              } else {
                addMSG(e.data, "other");
              }
            } catch(err) {
              addMSG(e.data, "other");
            }
          }
        }
      }

      function createAnswerSDP() {
        var offerDesc = new RTCSessionDescription(JSON.parse($("#creater-sdp").val()));
        pc.setRemoteDescription(offerDesc)
        pc.createAnswer(function (answerDesc) {
          pc.setLocalDescription(answerDesc)
        }, function () {console.warn("Couldn't create offer")},
        sdpConstraints);
      };

      var sendMSG = function() {
        var value = $("#msg").val();
        if (value) {
          dc.send(value);
          addMSG(value, "me");
          $("#msg").val('');
        }
      }

      var addMSG = function(msg, who) {
        var wrap = $("<div>").addClass("wrap").appendTo($("#chat-screen"));
        var div  = $("<div>").addClass(who).appendTo(wrap);
        $("<span>").html(who).addClass("who").appendTo(div);
        $("<span>").html(msg).addClass("msg").appendTo(div);
        $("#chat-screen-wp").scrollTop($("#chat-screen").height());
      }

      $("#create").click(createAnswerSDP);
      $("#msg").keypress(function(e) {if(e.which == 13) {sendMSG()}});
      $("#send").click(sendMSG);
    </script>
  </body>
</html>